rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Admin: Has 'admin' role OR is the Master Email
    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.role == 'admin' || 
        request.auth.token.email == 'goldenlamtouch@gmail.com'
      );
    }
    
    // Coordinator: Has 'coordinator' role
    function isCoordinator() {
      return isSignedIn() && request.auth.token.role == 'coordinator';
    }

    // Staff: Either Admin or Coordinator (for Dashboard "Read" access)
    function isStaff() {
      return isAdmin() || isCoordinator();
    }

    // --- RULES ---

    // 1. CONFIG: Strict Admin Only
    match /config/{docId} {
      allow read, write: if isAdmin();
    }

    // 2. FORMS: 
    // - Public needs to GET a single form to render it (form.html).
    // - Staff needs to LIST forms for Dashboard.
    // - Only Admin can CHANGE forms.
    match /forms/{formId} {
      allow get: if true; 
      allow list: if isStaff();
      allow create, update, delete: if isAdmin();
      
      match /private/{counterId} {
        allow read, write: if false; // Internal counters are hidden
      }
    }
    
    // 3. GROUPS: Staff needs to see them for filtering.
    match /groups/{groupId} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    
    // 4. SUBMISSIONS:
    // - Public creates them.
    // - Staff reads them (Dashboard).
    // - Only Admin updates/deletes.
    match /submissions/{submissionId} {
      allow create: if true;
      allow read: if isStaff();
      allow update, delete: if isAdmin();
    }
    
    // 5. OTPS: 
    // - Public needs to READ to verify code.
    // - Public needs to UPDATE to mark as 'used'.
    match /otps/{otpId} {
      allow read: if true;
      // Allow update ONLY if setting 'isUsed' to true (Prevent tampering with other fields)
      allow update: if true 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isUsed'])
                    && request.resource.data.isUsed == true;
      allow create, delete: if isAdmin();
    }

    // 6. COORDINATORS: 
    // - Admin manages them.
    // - Coordinators can read their OWN profile (needed for Login check).
    match /coordinators/{coordId} {
      allow write: if isAdmin();
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
    }

    // 7. SYSTEM LOGS: Admin Only
    match /system_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions write here
    }
  }
}